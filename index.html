<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Serviços de Manutenção</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<style>
  :root {
    --energisa-blue: #0097CE;
    --energisa-blue-dark: #0079a6;
    --energisa-orange: #F36F21;
    --bg-soft: #eef6fa;
    --bg-white: #ffffff;
    --text-dark: #333;
  }

  body {
    font-family: "Segoe UI", Roboto, sans-serif;
    background: var(--bg-soft);
    margin: 0;
  }

  .card {
    max-width: 900px;
    margin: 30px auto;
    padding: 28px;
    background: var(--bg-white);
    border-radius: 14px;
    box-shadow: 0 6px 26px rgba(0,0,0,0.10);
    border-top: 6px solid var(--energisa-orange);
  }

  h1 {
    text-align: center;
    color: var(--energisa-blue-dark);
    margin-bottom: 20px;
    font-size: 26px;
    font-weight: 800;
  }

  form { display: grid; gap: 15px; }

  label { font-weight: 600; margin-bottom: 4px; display:block; }

  input, select, textarea {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #cfd8dc;
    font-size: 15px;
    box-sizing: border-box;
  }

  .row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 18px;
  }

  @media(max-width: 720px) {
    .row { grid-template-columns: 1fr; }
  }

  button {
    background: var(--energisa-blue);
    color: white;
    border: none;
    padding: 14px;
    font-size: 16px;
    font-weight: 700;
    border-radius: 10px;
    cursor: pointer;
  }

  /* --- MENU INICIAL --- */
  .menu {
    display: grid;
    gap: 12px;
    margin-bottom: 18px;
  }
  .menu button {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    font-size: 16px;
  }
  .menu .btn-viva { background: var(--energisa-blue); }
  .menu .btn-morta { background: var(--energisa-orange); }
  .menu .sub {
    text-align: center;
    color: #555;
    font-size: 14px;
    margin-top: -6px;
  }

  /* --- BLOCO DE LOCALIZAÇÃO --- */
  .geo-box {
    background: var(--energisa-blue);
    padding: 14px;
    border-radius: 12px;
    color: white;
    margin-top: 10px;
  }

  .geo-row {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 12px;
    align-items: center;
  }

  #gps {
    background: #ffffff;
    border: none;
    padding: 12px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 15px;
    color: var(--text-dark);
  }

  #btnGeo {
    background: var(--energisa-orange);
    padding: 12px 16px;
    border-radius: 10px;
    font-weight: 700;
    border: none;
    cursor: pointer;
    color: #fff;
    white-space: nowrap;
  }

  /* OVERLAY ENVIANDO */
  #overlayEnvio {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }

  #overlayEnvio .box {
    background: #fff;
    padding: 30px 40px;
    border-radius: 14px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.35);
  }

  #overlayEnvio .spinner {
    width: 42px;
    height: 42px;
    border: 4px solid #e0e0e0;
    border-top: 4px solid #0097CE;
    border-radius: 50%;
    margin: 0 auto 15px;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  #previewBox img { max-height: 120px; border-radius: 8px; object-fit: cover; }

  /* esconder / mostrar */
  .hidden { display: none !important; }

  /* “badge” do modo selecionado */
  .mode-badge {
    display: inline-block;
    margin: 0 auto 10px;
    padding: 6px 10px;
    border-radius: 999px;
    background: #eef6fa;
    border: 1px solid #cfe6f2;
    color: #0b5c7d;
    font-weight: 700;
    font-size: 13px;
  }
</style>
</head>

<body>
  <div id="overlayEnvio">
    <div class="box">
      <div class="spinner"></div>
      <strong>Enviando registro…</strong>
      <div style="font-size:14px; margin-top:6px; color:#555">
        Aguarde alguns segundos
      </div>
    </div>
  </div>

  <div class="card">
    <h1>FORMULÁRIO - SERVIÇOS</h1>

    <!-- MENU INICIAL -->
    <div id="menuTipo" class="menu">
      <button type="button" class="btn-viva" id="btnLinhaViva">
        <i class="bi bi-lightning-charge-fill"></i> Serviço Linha Viva
      </button>
      <button type="button" class="btn-morta" id="btnLinhaMorta">
        <i class="bi bi-tools"></i> Serviço Linha Morta
      </button>
      <div class="sub">Escolha o tipo de serviço para abrir o formulário</div>
    </div>

    <!-- BADGE DO MODO -->
    <div id="modeBadge" class="mode-badge hidden"></div>

    <!-- AÇÕES (VOLTar) -->
<div id="acoesTopo" class="hidden" style="display:flex; justify-content:flex-start; margin: 10px 0 14px;">
  <button type="button" id="btnVoltarMenu" style="background:#6c757d;">
    <i class="bi bi-arrow-left"></i> Voltar
  </button>
</div>

    <form id="llForm" class="hidden" autocomplete="off" enctype="multipart/form-data">

      <!-- REGIONAL / BASE -->
      <div class="row">
        <div>
          <label>1. Regional *</label>
          <select id="regional" name="regional" required>
            <option value="">Selecione...</option>
            <option value="LESTE">LESTE</option>
            <option value="CENTRO">CENTRO</option>
            <option value="OESTE">OESTE</option>
          </select>
        </div>

        <div>
          <label>2. Base *</label>
          <select id="base" name="base" required disabled>
            <option value="">Selecione a regional primeiro...</option>
          </select>
        </div>
      </div>

      <!-- EQUIPE -->
      <div>
        <label>3. Equipe *</label>
        <select id="equipe" name="equipe" required disabled>
          <option value="">Selecione a base primeiro...</option>
        </select>
      </div>

      <div>
        <label>4. Data *</label>
        <input type="date" id="data" name="data" required>
      </div>

      <div>
        <label>5. Componente *</label>
        <input id="componente" name="componente" required>
      </div>

      <!-- CAMPOS EXCLUSIVOS LINHA MORTA -->
      <div id="blocoLinhaMorta" class="hidden">
        <div class="row">
          <div>
            <label>6. Tipo de rede *</label>
            <select id="tipoRede" name="tipoRede">
              <option value="">Selecione...</option>
              <option value="BT">Baixa Tensão</option>
              <option value="MT">Média Tensão</option>
            </select>
          </div>

          <div>
            <label>7. Tipos de serviços *</label>
            <select id="servicoLM" name="servicoLM">
              <option value="">Selecione...</option>
              <option value="PODA">PODA</option>
              <option value="REFORMA_DE_REDE">REFORMA DE REDE</option>
              <option value="AMBOS">AMBOS</option>
            </select>
          </div>
        </div>
      </div>

      <!-- LINHA VIVA: mantém seu serviço LL original -->
      <div id="blocoLinhaViva" class="row">
        <div>
          <label>6. Serviço LL *</label>
          <select id="servicoll" name="servicoll" required>
            <option value="">Selecione...</option>
            <option>Substituição de isolador pino</option>
            <option>Substituição de isolador de ancoragem</option>
            <option>Instalação de cabo protegido / bypass</option>
            <option>Reparo com emenda pré-formada</option>
            <option>Ponto quente em bucha secundária</option>
            <option>Abertura de jumper sem carga</option>
            <option>Fechamento de jumper sem carga</option>
            <option>Substituir chave fusível / faca</option>
            <option>Retirar by-pass</option>
            <option>Instalação de espaçadores</option>
            <option>Amarração Grinfa</option>
            <option>Retirar ninho</option>
            <option>Retirar pipa/objetos</option>
            <option>Instalação de elastômetro</option>
            <option>Poda de árvore em contato</option>
            <option>Mudança de TAP</option>
            <option>Conectores Estribo/GLV</option>
          </select>
        </div>

        <div>
          <label>7. Medidor</label>
          <input id="medidor" name="medidor">
        </div>
      </div>

      <div class="row">
        <div>
          <label>8. Condutor</label>
          <input id="condutor" name="condutor">
        </div>

        <div>
          <label>9. Alma de Aço *</label>
          <select id="almaaco" name="almaaco" required>
            <option>Sim</option>
            <option>Não</option>
            <option>Não Verificado</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>10. Acesso caminhão *</label>
          <select id="acessocaminhao" name="acessocaminhao" required>
            <option>Sim</option>
            <option>Não</option>
          </select>
        </div>

        <div>
          <label>11. Endereço *</label>
          <input id="endereco" name="endereco" required>
        </div>
      </div>

      <!-- ARQUIVOS -->
      <div>
        <label>12. Arquivo + Localização *</label>
        <input id="file" name="arquivos" type="file" accept="image/*" multiple required>

        <div id="previewBox" style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;"></div>

        <div class="geo-box">
          <div class="geo-row">
            <button type="button" id="btnGeo">
              <i class="bi bi-geo-alt-fill"></i> Localizar
            </button>
            <input id="gps" name="gps" readonly placeholder="Coordenadas aparecerão aqui" required />
          </div>
        </div>
      </div>

      <div>
        <label>13. Observação</label>
        <textarea id="observacao" name="observacao" rows="3"></textarea>
      </div>

      <button id="btnSubmit" type="submit">Enviar Registro</button>
    </form>
  </div>

<script>

  const acoesTopo = document.getElementById("acoesTopo");
const btnVoltarMenu = document.getElementById("btnVoltarMenu");

function voltarParaMenu() {
  // limpa tudo
  form.reset();
  document.getElementById("previewBox").innerHTML = "";
  baseEl.disabled = true;
  equipeEl.disabled = true;

  // limpa modo
  tipoServicoSelecionado = "";

  // volta UI
  form.classList.add("hidden");
  badge.classList.add("hidden");
  acoesTopo.classList.add("hidden");
  menuTipo.classList.remove("hidden");
}

btnVoltarMenu.onclick = voltarParaMenu;

  
/* =============================================================
   BASES POR REGIONAL
   ============================================================= */
const basesPorRegional = {
  "LESTE": ["Cruz do Peixe","Cabedelo","Mangabeira","Paratibe","Santa Rita","João Pessoa","Mamanguape","Sapé","Itabaiana","Caaporã"],
  "CENTRO": ["Campina Grande","Borborema","Esperança","Guarabira","Monteiro"],
  "OESTE": ["Itaporanga","Patos","Sousa","Catolé do Rocha","Princesa Isabel","Cajazeiras"]
};

/* =============================================================
   EQUIPES POR BASE
   ============================================================= */
const equipesPorBase = {
  "Cruz do Peixe": ["CPXCE01","CPXCE03","CPXME01","CPXME02","CPXSN02","CPXML01","CPXSN01","CPXSN02","CPXSN03","CPXSN52","JPSINS04","SUPERVISÃO"],
  "Cabedelo": ["CBDCE01","CBDCE02","CBDCE03","CBDCE04","CBDCR01","CBDSN01","CBDSN02","CBDSN05","CBDSN06","CBDML01","CBDLL01","CBDSN70","SUPERVISÃO"],
  "Mangabeira": ["MGBCE01","MGBCE02","MGBCE03","MGBCE04","MGBCR01","MGBCR03","MGBSN01","MGBSN02","MGBML01","MGBSN50","MGBSN70","JPSINS03","SUPERVISÃO"],
  "Paratibe": ["PRTCE01","PRTCR03","PRTSN02","PRTML01","PRTCR01","SUPERVISÃO"],
  "Santa Rita": ["STRCE01","STRCE03","STRCE04","STRCR01","STRCR02","STRCR03","STRCR04","STRCR05","STRCR06","STRSN01","STRML01","LCNSN01","JPSINS02","SUPERVISÃO"],
  "João Pessoa": ["JPSLL01","JPSML01","JPSML02","JPSCE01","JPSCE02","JPSCE03","JPSCE04","JPSCE05","JPSCE06","JPSCE07","JPSCE08","JPSCE09","JPSCE12","JPSCE13","JPSCE14","JPSCE15","JPSCE16","JPSME01","JPSME02","JPSME03","JPSSN04","JPSSN05","JPSINS04","SUPERVISÃO"],
  "Mamanguape": ["MAAML01","MAASN01","MAMCR01","MAMMO01","MAMSN01","MAMSN03","MAMINS1","SUPERVISÃO"],
  "Sapé": ["SPECR01","SPECR02","SPESN01","SPESN02","SPEML04","SUPERVISÃO"],
  "Itabaiana": ["ITAML01","ITASN01","ITASN02","ITASN03","ITASN05","ITASN70","INGSN01","INGSN02","ITASN03","SUPERVISÃO"],
  "Caaporã": ["CAASN01","CAASN02","CAASN03","CAASN04","CAASN70","SUPERVISÃO"],

  "Campina Grande": ["CGDCE02","CGDCX01","CGDME04","CGDME05","CGDMO03","CGDMO04","CGDMO05","CGDMO06","CGDMO07","CGDMO10","CGDSN01","CGDSN02","CGDSN03","CGDSN04","CGDSN05","CGDSN06","CGDSN07","GLTSN01","ABRSN02","ABRSN50","ABRSN51","LGSSN01","CGDSN71","QMDSN01","SUPERVISÃO"],
  "Borborema": ["BQRSN01","BQRSN03","BQRSN50","ACTSN01","JZRML01","JZRSN02","SLDSN01","UBZSN01","SUPERVISÃO"],
  "Esperança": ["ESPBT03","ESPCE01","ESPML01","ESPSN01","CTESN01","SUPERVISÃO"],
  "Guarabira": ["SLNSN01","SLNCE01","GBACE02","GBAME16","GBAMO11","GBAMO12","GBAMO13","GBASN02","GBASN05","GBASN51","GBASN52","GBAML09","GBAML01","ARNSN03","ALGSN01","BLMSN01","ARNSN03","SUPERVISÃO"],
  "Monteiro": ["MNTMO01","MNTMO02","MNTSN01","MNTSN02","MNTSN50","SMESN01","CMLSN01","SUPERVISÃO"],

  "Itaporanga": ["CONSN01","ITOCR01","ITOSN01","ITOSN02","PCOSN50","SUPERVISÃO"],
  "Patos": ["PTSAD02","PTSCE01","PTSCR03","PTSME01","PTSMO01","PTSMO03","PTSSN02","PTSSN03","PTSSN06","TXRSN02","PTSSN57","PTSSN01","PRISN02","PRISN03","SUPERVISÃO"],
  "Sousa": ["SZACE01","SZAAD03","SZAAD04","SZAAD05","SZAME01","SZAME02","SZAME03","SZAMO05","SZAMO06","SZAML01","SZASN55","SZASN01","URNSN01","SBTSN50","SBTSN03","NAZSN01","SUPERVISÃO"],
  "Catolé do Rocha": ["CTRMO01","CTRSN03","CTRSN50","SUPERVISÃO"],
  "Princesa Isabel": ["PRISN02","SUPERVISÃO"],
  "Cajazeiras": ["CJZCR01","CJZME01","CJZMO03","CJZMO04","CJZSN01","CJZSN03","CJZCR01","SUPERVISÃO"]
};

/* =============================================================
   CALCULAR REGIONAL A PARTIR DA BASE
   ============================================================= */
function calcularRegionalPorBase(base) {
  if (!base) return "NÃO ENCONTRADA";
  for (const regional in basesPorRegional) {
    if (basesPorRegional[regional].includes(base)) return regional;
  }
  return "NÃO ENCONTRADA";
}

/* =============================================================
   MENU: LINHA VIVA / LINHA MORTA
   ============================================================= */
let tipoServicoSelecionado = ""; // "LINHA_VIVA" | "LINHA_MORTA"

const menuTipo = document.getElementById("menuTipo");
const form = document.getElementById("llForm");
const badge = document.getElementById("modeBadge");

const blocoViva = document.getElementById("blocoLinhaViva");
const blocoMorta = document.getElementById("blocoLinhaMorta");
const tipoRedeEl = document.getElementById("tipoRede");
const servicoLMEl = document.getElementById("servicoLM");
const servicollEl = document.getElementById("servicoll");

function abrirFormulario(modo) {
  tipoServicoSelecionado = modo;

  menuTipo.classList.add("hidden");
  form.classList.remove("hidden");
  badge.classList.remove("hidden");
  acoesTopo.classList.remove("hidden");

  if (modo === "LINHA_VIVA") {
    badge.textContent = "Modo selecionado: LINHA VIVA";
    blocoViva.classList.remove("hidden");
    blocoMorta.classList.add("hidden");

    // Viva: serviço LL obrigatório
    servicollEl.required = true;

    // Morta: campos não obrigatórios
    tipoRedeEl.required = false;
    servicoLMEl.required = false;
    tipoRedeEl.value = "";
    servicoLMEl.value = "";

    document.getElementById("btnSubmit").textContent = "Enviar Registro (Linha Viva)";
  } else {
    badge.textContent = "Modo selecionado: LINHA MORTA";
    blocoViva.classList.add("hidden");
    blocoMorta.classList.remove("hidden");

    // Morta: campos obrigatórios
    tipoRedeEl.required = true;
    servicoLMEl.required = true;

    // Viva: não obrigatório e limpa
    servicollEl.required = false;
    servicollEl.value = "";

    document.getElementById("btnSubmit").textContent = "Enviar Registro (Linha Morta)";
  }
}

document.getElementById("btnLinhaViva").onclick = () => abrirFormulario("LINHA_VIVA");
document.getElementById("btnLinhaMorta").onclick = () => abrirFormulario("LINHA_MORTA");

/* =============================================================
   DATA ATUAL AUTOMÁTICA
   ============================================================= */
document.getElementById("data").value = new Date().toISOString().slice(0,10);

/* =============================================================
   REGIONAL → BASE
   ============================================================= */
const regionalEl = document.getElementById("regional");
const baseEl = document.getElementById("base");
const equipeEl = document.getElementById("equipe");

regionalEl.addEventListener("change", () => {
  const regional = regionalEl.value;

  baseEl.innerHTML = "<option value=''>Selecione a base...</option>";
  equipeEl.innerHTML = "<option value=''>Selecione a base primeiro...</option>";
  baseEl.disabled = true;
  equipeEl.disabled = true;

  if (!regional) return;

  basesPorRegional[regional].forEach(b => {
    const op = document.createElement("option");
    op.value = b;
    op.textContent = b;
    baseEl.appendChild(op);
  });

  baseEl.disabled = false;
});

/* =============================================================
   BASE → EQUIPE
   ============================================================= */
baseEl.addEventListener("change", () => {
  const base = baseEl.value;

  equipeEl.innerHTML = "<option value=''>Selecione...</option>";
  equipeEl.disabled = true;

  if (!base || !equipesPorBase[base]) return;

  equipesPorBase[base].forEach(eq => {
    const op = document.createElement("option");
    op.value = eq;
    op.textContent = eq;
    equipeEl.appendChild(op);
  });

  equipeEl.disabled = false;
});

/* =============================================================
   PREVIEW DAS IMAGENS
   ============================================================= */
document.getElementById("file").onchange = e => {
  const preview = document.getElementById("previewBox");
  preview.innerHTML = "";

  [...e.target.files].forEach(f => {
    if (!f.type.startsWith("image/")) return;
    const img = document.createElement("img");
    img.src = URL.createObjectURL(f);
    img.style.maxHeight = "120px";
    img.style.borderRadius = "8px";
    preview.appendChild(img);
  });
};

/* =============================================================
   GPS
   ============================================================= */
document.getElementById("btnGeo").onclick = () => {
  const gps = document.getElementById("gps");
  gps.value = "Capturando localização...";
  navigator.geolocation.getCurrentPosition(
    pos => gps.value = `${pos.coords.latitude}, ${pos.coords.longitude}`,
    () => gps.value = "Erro ao obter localização"
  );
};

/* =============================================================
   COMPRESSÃO DE IMAGEM
   ============================================================= */
function compressImage(file) {
  return new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.src = e.target.result;
      img.onload = () => {
        const canvas = document.createElement("canvas");
        const scale = Math.min(1, 1280 / img.width);
        canvas.width = img.width * scale;
        canvas.height = img.height * scale;
        canvas.getContext("2d").drawImage(img, 0, 0, canvas.width, canvas.height);
        canvas.toBlob(b => resolve(b), "image/jpeg", 0.7);
      };
    };
    reader.readAsDataURL(file);
  });
}

/* =============================================================
   SUBMIT + OVERLAY ENVIANDO
   ============================================================= */
const SUBMIT_URL = "https://withered-hat-347d.pedro-fillype.workers.dev/submit";

document.getElementById("llForm").onsubmit = async e => {
  e.preventDefault();

  if (!tipoServicoSelecionado) {
    alert("Selecione: Linha Viva ou Linha Morta.");
    return;
  }

  const overlay = document.getElementById("overlayEnvio");
  const btn = document.getElementById("btnSubmit");
  overlay.style.display = "flex";
  btn.disabled = true;

  try {
    const fd = new FormData();
    const files = document.getElementById("file").files;
    if (!files.length) throw "Selecione ao menos uma imagem.";

    for (let i = 0; i < files.length; i++) {
      const blob = await compressImage(files[i]);
      fd.append("arquivos", new File([blob], `foto_${i+1}.jpg`, { type:"image/jpeg" }));
    }

    // campos comuns
    const camposComuns = [
      "base","equipe","data","componente",
      "medidor","condutor","almaaco","acessocaminhao",
      "endereco","gps","observacao"
    ];

    for (const id of camposComuns) {
  const el = document.getElementById(id);
  if (!el) continue;

  // ✅ Só valida se o campo for required no HTML
  if (el.required && !String(el.value || "").trim()) {
    throw `Campo obrigatório não preenchido: ${id}`;
  }

  // ✅ Envia mesmo vazio (opcionais)
  fd.append(id, el.value || "");
}

    // modo escolhido
    fd.append("tipo_servico", tipoServicoSelecionado);

    // campos específicos
    if (tipoServicoSelecionado === "LINHA_VIVA") {
      if (!servicollEl.value) throw "Selecione o Serviço LL.";
      fd.append("servicoll", servicollEl.value);
    } else {
      if (!tipoRedeEl.value) throw "Selecione o Tipo de rede.";
      if (!servicoLMEl.value) throw "Selecione o Tipo de serviço (Linha Morta).";
      fd.append("tipo_rede", tipoRedeEl.value);
      fd.append("servico_lm", servicoLMEl.value);
    }

    // regional calculada pela base
    const regionalCalculada = calcularRegionalPorBase(baseEl.value);
    fd.append("regional", regionalCalculada);

    const r = await fetch(SUBMIT_URL, { method:"POST", body: fd });
    if (!r.ok) throw await r.text();

    alert("Registro enviado com sucesso!");

    // reset geral
    form.reset();
    document.getElementById("previewBox").innerHTML = "";
    baseEl.disabled = true;
    equipeEl.disabled = true;

    // volta para menu
    form.classList.add("hidden");
    badge.classList.add("hidden");
    menuTipo.classList.remove("hidden");
    tipoServicoSelecionado = "";

  } catch (err) {
    alert(err);
  } finally {
    overlay.style.display = "none";
    btn.disabled = false;
  }
};
</script>
</body>
</html>
