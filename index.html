<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Serviços LL - Linha Viva Leve</title>

<!-- ÍCONES -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<style>
  :root {
    --energisa-blue: #0097CE;
    --energisa-blue-dark: #0079a6;
    --energisa-orange: #F36F21;
    --bg-soft: #eef6fa;
    --bg-white: #ffffff;
    --text-dark: #333;
  }

  body {
    font-family: "Segoe UI", Roboto, sans-serif;
    background: var(--bg-soft);
    margin: 0;
  }

  .card {
    max-width: 900px;
    margin: 30px auto;
    padding: 28px;
    background: var(--bg-white);
    border-radius: 14px;
    box-shadow: 0 6px 26px rgba(0,0,0,0.10);
    border-top: 6px solid var(--energisa-orange);
  }

  h1 {
    text-align: center;
    color: var(--energisa-blue-dark);
    margin-bottom: 20px;
    font-size: 26px;
    font-weight: 800;
  }

  form {
    display: grid;
    gap: 15px;
  }

  label {
    font-weight: 600;
    margin-bottom: 4px;
  }

  input, select, textarea {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #cfd8dc;
    font-size: 15px;
  }

  .row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 18px;
  }

  @media(max-width: 720px) {
    .row { grid-template-columns: 1fr; }
  }

  button {
    background: var(--energisa-blue);
    color: white;
    border: none;
    padding: 14px;
    font-size: 16px;
    font-weight: 700;
    border-radius: 10px;
    cursor: pointer;
  }

  /* --- BLOCO DE LOCALIZAÇÃO --- */
  .geo-box {
    background: var(--energisa-blue);
    padding: 14px;
    border-radius: 12px;
    color: white;
    margin-top: 10px;
  }

  .geo-row {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 12px;
    align-items: center;
  }

  #gps {
    background: #ffffff;
    border: none;
    padding: 12px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 15px;
    color: var(--text-dark);
  }

  #btnGeo {
    background: var(--energisa-orange);
    padding: 12px 16px;
    border-radius: 10px;
    font-weight: 700;
    border: none;
    cursor: pointer;
    color: #fff;
    white-space: nowrap;
  }
</style>
</head>

<body>

<div class="card">
  <h1>FORMULÁRIO - SERVIÇOS LL</h1>

  <form id="llForm" autocomplete="off" enctype="multipart/form-data">

    <!-- EQUIPES -->
    <div>
      <label>1. Equipe *</label>
      <select id="equipe" name="equipe" required>
        <option value="">Selecione a Regional e a Base...</option>
      </select>
    </div>

    <div class="row">
      <div>
        <label>2. Regional *</label>
        <select id="regional" name="regional" required>
          <option value="">Selecione...</option>
          <option>CENTRO</option>
          <option>LESTE</option>
          <option>OESTE</option>
        </select>
      </div>

      <div>
        <label>3. Base *</label>
        <select id="base" name="base" required>
          <option value="">Selecione...</option>
        </select>
      </div>
    </div>

    <div>
      <label>4. Componente *</label>
      <input id="componente" name="componente" required>
    </div>

    <div class="row">
      <div>
        <label>5. Serviço LL *</label>
        <select id="servicoll" name="servicoll" required>
          <option value="">Selecione...</option>
          <option>Substituição de isolador pino</option>
          <option>Substituição de isolador de ancoragem</option>
          <option>Instalação de cabo protegido / bypass</option>
          <option>Reparo com emenda pré-formada</option>
          <option>Ponto quente em bucha secundária</option>
          <option>Abertura de jumper sem carga</option>
          <option>Fechamento de jumper sem carga</option>
          <option>Substituir chave fusível / faca</option>
          <option>Retirar by-pass</option>
          <option>Instalação de espaçadores</option>
          <option>Amarração Grinfa</option>
          <option>Retirar ninho</option>
          <option>Retirar pipa/objetos</option>
          <option>Instalação de elastômetro</option>
          <option>Poda de árvore em contato</option>
          <option>Mudança de TAP</option>
        </select>
      </div>

      <div>
        <label>6. Medidor *</label>
        <input id="medidor" name="medidor" required>
      </div>
    </div>

    <div class="row">
      <div>
        <label>7. Condutor *</label>
        <input id="condutor" name="condutor" required>
      </div>

      <div>
        <label>8. Alma de Aço *</label>
        <select id="almaaco" name="almaaco" required>
          <option>Sim</option>
          <option>Não</option>
          <option>Não Verificado</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>9. Acesso caminhão *</label>
        <select id="acessocaminhao" name="acessocaminhao" required>
          <option>Sim</option>
          <option>Não</option>
        </select>
      </div>

      <div>
        <label>10. Endereço *</label>
        <input id="endereco" name="endereco" required>
      </div>
    </div>

    <!-- ARQUIVOS -->
    <div>
      <label>11. Arquivo + Localização *</label>
      <input id="file" name="arquivos" type="file" accept="image/*" multiple required>

      <div id="previewBox" style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;"></div>

      <div class="geo-box">
        <div class="geo-row">
          <button type="button" id="btnGeo">
            <i class="bi bi-geo-alt-fill"></i> Localizar
          </button>
          <input id="gps" name="gps" readonly placeholder="Coordenadas aparecerão aqui" required />
        </div>
      </div>
    </div>

    <div>
      <label>12. Observação</label>
      <textarea id="observacao" name="observacao" rows="3"></textarea>
    </div>

    <button id="btnSubmit" type="submit">Enviar Registro LL</button>

  </form>
</div>


<script>
/* ===========================================================
      1. LISTA DE EQUIPES POR REGIONAL
=========================================================== */
const equipes = {
  "CENTRO": [...],
  "LESTE": [...],
  "OESTE": [...]
};

/* ===========================================================
      2. BASES POR REGIONAL
=========================================================== */
const basesPorRegional = {
  "CENTRO": ["Sede","Santa Rita","Cruz do Peixe","Mangabeira","Paratibe"],
  "LESTE": ["Cabedelo","Caaporã","Mamanguape","Sapé","Itabaiana"],
  "OESTE": ["Itabaiana","Princesa Isabel","Patos","Sousa","Cajazeiras"]
};

/* ===========================================================
      3. AUTO-PREENCHER "BASE" QUANDO SELECIONAR REGIONAL
=========================================================== */
document.getElementById("regional").addEventListener("change", () => {
  const regional = document.getElementById("regional").value;
  const base = document.getElementById("base");

  base.innerHTML = `<option value="">Selecione...</option>`;

  if (basesPorRegional[regional]) {
    basesPorRegional[regional].forEach(b => {
      const op = document.createElement("option");
      op.value = b;
      op.textContent = b;
      base.appendChild(op);
    });
  }
});

/* ===========================================================
      4. CARREGAR EQUIPES QUANDO BASE FOR SELECIONADA
=========================================================== */
document.getElementById("base").addEventListener("change", () => {
  const regional = document.getElementById("regional").value;
  const equipe = document.getElementById("equipe");

  equipe.innerHTML = `<option value="">Selecione...</option>`;

  if (equipes[regional]) {
    equipes[regional].forEach(eq => {
      const op = document.createElement("option");
      op.value = eq;
      op.textContent = eq;
      equipe.appendChild(op);
    });
  }
});

/* ===========================================================
      5. MAPA PARA AUTO-IDENTIFICAR A BASE PELA SIGLA
=========================================================== */
const baseMap = {
  "CPX": "Cruz do Peixe",
  "CBD": "Cabedelo",
  "MGB": "Mangabeira",
  "PRT": "Paratibe",
  "STR": "Santa Rita",
  "JPS": "Sede",
  "MAM": "Mamanguape",
  "SPE": "Sapé",
  "ITA": "Itabaiana",
  "CAA": "Caaporã"
};

document.getElementById("equipe").addEventListener("input", () => {
  const equipe = document.getElementById("equipe").value.trim();
  if (equipe.length >= 3) {
    const sigla = equipe.substring(0,3).toUpperCase();
    if (baseMap[sigla]) {
      document.getElementById("base").value = baseMap[sigla];
    }
  }
});

/* ===========================================================
      6. PREVIEW DAS IMAGENS
=========================================================== */
document.getElementById('file').onchange = e => {
  const files = e.target.files;
  const preview = document.getElementById("previewBox");
  preview.innerHTML = "";
  [...files].forEach(f => {
    if (f.type.startsWith("image/")) {
      const img = document.createElement("img");
      img.src = URL.createObjectURL(f);
      img.style.maxHeight = "180px";
      img.style.borderRadius = "8px";
      img.style.boxShadow = "0 2px 8px rgba(0,0,0,0.3)";
      preview.appendChild(img);
    }
  });
};

/* ===========================================================
      7. GPS
=========================================================== */
document.getElementById('btnGeo').onclick = () => {
  const gps = document.getElementById('gps');
  gps.value = "Capturando localização...";
  navigator.geolocation.getCurrentPosition(
    pos => gps.value = pos.coords.latitude + ", " + pos.coords.longitude,
    err => gps.value = "Erro ao obter localização"
  );
};

/* ===========================================================
      8. COMPRESSÃO DE IMAGENS
=========================================================== */
function compressImage(file) {
  return new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.src = e.target.result;
      img.onload = () => {
        const canvas = document.createElement("canvas");
        const maxWidth = 1280;
        const scale = maxWidth / img.width;
        canvas.width = maxWidth;
        canvas.height = img.height * scale;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        canvas.toBlob(
          blob => resolve(blob),
          "image/jpeg",
          0.7
        );
      };
    };
    reader.readAsDataURL(file);
  });
}

/* ===========================================================
      9. SUBMIT
=========================================================== */
const SUBMIT_URL = "https://withered-hat-347d.pedro-fillype.workers.dev/submit";

document.getElementById("llForm").onsubmit = async e => {
  e.preventDefault();

  const fd = new FormData();
  const files = document.getElementById("file").files;

  if (!files.length) {
    alert("Selecione ao menos uma imagem.");
    return;
  }

  for (let i = 0; i < files.length; i++) {
    const blob = await compressImage(files[i]);
    fd.append("arquivos", new File([blob], `foto_${i+1}.jpg`, { type: "image/jpeg" }));
  }

  ["equipe","regional","base","componente","servicoll","medidor","condutor",
   "almaaco","acessocaminhao","endereco","gps","observacao"]
  .forEach(id => fd.append(id, document.getElementById(id).value));

  const r = await fetch(SUBMIT_URL, { method:"POST", body: fd });

  if (r.ok) {
    alert("Registro LL enviado com sucesso!");
    llForm.reset();
    previewBox.innerHTML = "";
  } else {
    alert("Erro ao enviar: " + await r.text());
  }
};

</script>

</body>
</html>
