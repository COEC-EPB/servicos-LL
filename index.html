<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Servi√ßos LL - Linha Viva Leve</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<style>
  :root {
    --energisa-blue: #0097CE;
    --energisa-blue-dark: #0079a6;
    --energisa-orange: #F36F21;
    --bg-soft: #eef6fa;
    --bg-white: #ffffff;
    --text-dark: #333;
  }

  body {
    font-family: "Segoe UI", Roboto, sans-serif;
    background: var(--bg-soft);
    margin: 0;
  }

  .card {
    max-width: 900px;
    margin: 30px auto;
    padding: 28px;
    background: var(--bg-white);
    border-radius: 14px;
    box-shadow: 0 6px 26px rgba(0,0,0,0.10);
    border-top: 6px solid var(--energisa-orange);
  }

  h1 {
    text-align: center;
    color: var(--energisa-blue-dark);
    margin-bottom: 20px;
    font-size: 26px;
    font-weight: 800;
  }

  form { display: grid; gap: 15px; }
  label { font-weight: 600; margin-bottom: 4px; }

  input, select, textarea {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #cfd8dc;
    font-size: 15px;
  }

  .row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 18px;
  }
  @media(max-width: 720px) { .row { grid-template-columns: 1fr; } }

  button {
    background: var(--energisa-blue);
    color: white;
    border: none;
    padding: 14px;
    font-size: 16px;
    font-weight: 700;
    border-radius: 10px;
    cursor: pointer;
  }

  #btnGeo {
    margin-top: 8px;
    background: var(--energisa-orange);
  }

</style>
</head>
<body>

<div class="card">
  <h1>FORMUL√ÅRIO - SERVI√áOS LL</h1>

  <form id="llForm" autocomplete="off" enctype="multipart/form-data">

    <div><label>1. Equipe *</label><input id="equipe" name="equipe" required></div>

    <div class="row">
      <div>
        <label>2. Base *</label>
        <select id="base" name="base" required>
          <option value="">Selecione...</option>
          <option>Jo√£o Pessoa</option>
          <option>Campina Grande</option>
          <option>Patos</option>
          <option>Outros</option>
        </select>
      </div>

      <div>
        <label>3. Componente *</label>
        <input id="componente" name="componente" required>
      </div>
    </div>

    <div class="row">
      <div>
        <label>4. Servi√ßo LL *</label>
        <select id="servicoll" name="servicoll" required>
          <option value="">Selecione...</option>
          <option>Inspe√ß√£o</option>
          <option>Instala√ß√£o</option>
          <option>Manuten√ß√£o</option>
          <option>Retirada</option>
        </select>
      </div>

      <div>
        <label>5. Medidor *</label>
        <input id="medidor" name="medidor" required>
      </div>
    </div>

    <div class="row">
      <div>
        <label>6. Condutor *</label>
        <input id="condutor" name="condutor" required>
      </div>

      <div>
        <label>7. Alma de A√ßo *</label>
        <select id="almaaco" name="almaaco" required>
          <option>Sim</option>
          <option>N√£o</option>
          <option>N√£o Verificado</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>8. Acesso caminh√£o *</label>
        <select id="acessocaminhao" name="acessocaminhao" required>
          <option>Sim</option>
          <option>N√£o</option>
        </select>
      </div>

      <div>
        <label>9. Endere√ßo *</label>
        <input id="endereco" name="endereco" required>
      </div>
    </div>

    <div>
      <label>10. Arquivo + Localiza√ß√£o *</label>

      <input id="file" name="arquivo" type="file" accept="image/*" required>

      <button type="button" id="btnGeo">Obter Geolocaliza√ß√£o</button>

      <input id="gps" name="gps" readonly placeholder="Coordenadas aparecer√£o aqui" required />

      <img id="preview" style="max-height:200px; margin-top:10px; display:none;" />
    </div>

    <div>
      <label>11. Observa√ß√£o</label>
      <textarea id="observacao" name="observacao" rows="3"></textarea>
    </div>

    <button id="btnSubmit" type="submit">Enviar Registro LL</button>

  </form>
</div>

<script>
const SUBMIT_URL = "https://withered-hat-347d.pedro-fillype.workers.dev/submit";

/* ‚û§ FUN√á√ÉO DE COMPRESS√ÉO AUTOM√ÅTICA */
function compressImage(file) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.src = e.target.result;

      img.onload = () => {
        const canvas = document.createElement("canvas");

        const maxWidth = 1280; // Reduz bem o tamanho
        const scale = maxWidth / img.width;

        canvas.width = maxWidth;
        canvas.height = img.height * scale;

        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        canvas.toBlob(
          blob => resolve(blob),
          "image/jpeg",
          0.7 // qualidade da compress√£o
        );
      };
    };
    reader.readAsDataURL(file);
  });
}

/* GEOLOCATION */
document.getElementById('btnGeo').onclick = () => {
  const gps = document.getElementById('gps');
  gps.value = "Capturando localiza√ß√£o...";

  navigator.geolocation.getCurrentPosition(
    pos => gps.value = pos.coords.latitude + ", " + pos.coords.longitude,
    err => gps.value = "Erro ao obter localiza√ß√£o"
  );
};

/* FILE PREVIEW */
document.getElementById('file').onchange = e => {
  const file = e.target.files[0];
  const prev = document.getElementById('preview');
  if (file && file.type.startsWith("image/")) {
    prev.src = URL.createObjectURL(file);
    prev.style.display = "block";
  } else {
    prev.style.display = "none";
  }
};

/* ‚û§ ENVIO COM COMPRESS√ÉO AUTOM√ÅTICA */
document.getElementById('llForm').onsubmit = async e => {
  e.preventDefault();

  const fileInput = document.getElementById("file");
  const file = fileInput.files[0];

  // üî• COMPRESS√ÉO AUTOM√ÅTICA
  const compressedBlob = await compressImage(file);
  const compressedFile = new File([compressedBlob], "foto_comprimida.jpg", { type: "image/jpeg" });

  const fd = new FormData();

  // substitui apenas a imagem
  fd.append("arquivo", compressedFile);

  // inclui o resto dos campos
  const fields = ["equipe","base","componente","servicoll","medidor","condutor","almaaco","acessocaminhao","endereco","gps","observacao"];
  fields.forEach(id => fd.append(id, document.getElementById(id).value));

  const resp = await fetch(SUBMIT_URL, { method: "POST", body: fd });

  if (resp.ok) {
    alert("Registro LL enviado com sucesso!");
    llForm.reset();
    preview.style.display = "none";
  } else {
    const txt = await resp.text();
    alert("Erro ao enviar: " + txt);
  }
};
</script>

</body>
</html>
